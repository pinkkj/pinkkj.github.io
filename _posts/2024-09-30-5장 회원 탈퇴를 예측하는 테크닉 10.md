---
# Header
title: "5.íšŒì› íƒˆí‡´ë¥¼ ì˜ˆì¸¡í•˜ëŠ” í…Œí¬ë‹‰ 10"
excerpt: "íšŒì› íƒˆí‡´ë¥¼ ì˜ˆì¸¡í•˜ëŠ” í…Œí¬ë‹‰ 10"
name: J
writer: J
categories: [ë°ë¹„&ì¶”ì²œì‹œìŠ¤í…œ, íŒŒì´ì¬ ë°ì´í„°ë¶„ì„ ì‹¤ë¬´ í…Œí¬ë‹‰ 100] # [ë©”ì¸ ì¹´í…Œê³ ë¦¬, ì„œë¸Œ ì¹´í…Œê³ ë¦¬]
tags:
  - [Khuda, ML, data]

toc: true
toc_sticky: true

date: 2024-09-30
last_modified_at: 2024-09-30

# --- ì•„ë˜ ë¶€í„° content
---

ğŸ”–ì „ì œì¡°ê±´

ì—¬ê¸°ì„œëŠ” use_log_months.cvì™€ customer_join.csv

![alt text](/assets/img_20241002/image.png)

# 041.ë°ì´í„°ë¥¼ ì½ì–´ ë“¤ì´ê³  ì´ìš© ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ì

```py
import pandas as pd
customer = pd.read_csv("customer_join.csv")
uselog_months = pd.read_csv("use_log_months.csv")
```

### ì´ìš© ë°ì´í„° ì½ì–´ë“¤ì´ê¸°

```py
year_months = list(uselog_months["ì—°ì›”"].unique())
uselog = pd.DataFrame()
for i in range(1, len(year_months)):
    tmp = uselog_months.loc[uselog_months["ì—°ì›”"]==year_months[i]]
    tmp.rename(columns={"count":"count_0"}, inplace=True)
    tmp_before = uselog_months.loc[uselog_months["ì—°ì›”"]==year_months[i-1]]
    del tmp_before["ì—°ì›”"]
    tmp_before.rename(columns={"count":"count_1"}, inplace=True)
    tmp = pd.merge(tmp, tmp_before, on="customer_id", how="left")
    uselog = pd.concat([uselog,tmp], ignore_index=True)
uselog.head()
```
![alt text](/assets/img_20241002/image-1.png)

# 042.íƒˆí‡´ ì „ì›”ì˜ íƒˆí‡´ ê³ ê° ë°ì´í„°ë¥¼ ì‘ì„±í•˜ì

â“ì™œ end_date ì¹¼ëŸ¼ì˜ íƒˆí‡´ ì›”ì´ ì•„ë‹Œ íƒˆí‡´ ì „ì›”ì˜ ë°ì´í„°ë¥¼ ì‘ì„±?<br>
ğŸ’¡ì›”ë§ê¹Œì§€ íƒˆí‡´ ì‹ ì²­ì„ í•´ì•¼ ë‹¤ìŒ ë‹¬ ë§ì— íƒˆí‡´í•  ìˆ˜ ìˆìŒ. ë”°ë¼ì„œ íƒˆí‡´ ì›”ì„ ì‹¤ì œ íƒˆí‡´ ì›” í•œë‹¬ ì „ìœ¼ë¡œ ì„¤ì •í•˜ê³  1ë‹¬ ì „ì˜ ë°ì´í„°ë¡œë¶€í„° íƒˆí‡´ ì‹ ì²­ì„ í•  í™•ë¥ ì„ ì˜ˆì¸¡!

![alt text](/assets/img_20241002/image-2.png)

### ë°ì´í„° ìˆ˜ì •

íƒˆí‡´í•œ íšŒì›ì„ ì¶”ì¶œí•˜ê³  end_dateì˜ 1ê°œì›” ì „ì„ ê³„ì‚°í•´ì„œ ì—°ì›”ì— ì €ì¥!

```py
from dateutil.relativedelta import relativedelta
exit_customer = customer.loc[customer["is_deleted"]==1]
exit_customer["exit_date"] = None
exit_customer["end_date"] = pd.to_datetime(exit_customer["end_date"])
for i in range(len(exit_customer)):
    exit_customer["exit_date"].iloc[i] = exit_customer["end_date"].iloc[i] - relativedelta(months=1)
exit_customer["ì—°ì›”"] = pd.to_datetime(exit_customer["exit_date"]).dt.strftime("%Y%m")
uselog["ì—°ì›”"] = uselog["ì—°ì›”"].astype(str)
exit_uselog = pd.merge(uselog, exit_customer, on=["customer_id", "ì—°ì›”"], how="left")
print(len(uselog))
# 33851
exit_uselog.head()
```
![alt text](/assets/img_20241002/image-3.png)

### ê²°ì¸¡ì¹˜ ì œê±°

ê²°í•©í•œ ë°ì´í„°ëŠ” íƒˆí‡´í•œ íšŒì›ì˜ íƒˆí‡´ ì „ì›”ì˜ ë°ì´í„°ë¿ì´ë¯€ë¡œ ê²°ì¸¡ì¹˜ê°€ ë§ìŒ.

```py
exit_uselog = exit_uselog.dropna(subset=["name"])
#"name" ì¹¼ëŸ¼ì˜ ê²°ì¸¡ì¹˜ë§Œ ì‹ ê²½ì“°ê² ë‹¤.
print(len(exit_uselog))
#1104
print(len(exit_uselog["customer_id"].unique()))
#1104
exit_uselog.head()
```
![alt text](/assets/img_20241002/image-4.png)

# 043.ì§€ì† íšŒì›ì˜ ë°ì´í„°ë¥¼ ì‘ì„±í•˜ì

### ì§€ì† íšŒì› ë°ì´í„° ì‘ì„±

```py
conti_customer = customer.loc[customer["is_deleted"]==0]
conti_uselog = pd.merge(uselog, conti_customer, on=["customer_id"], how="left")
#onì— "ì—°ì›”"ì•ˆì“°ëŠ” ì´ìœ : íƒˆí‡´ ì›”ì´ ì—†ê¸° ë•Œë¬¸ì— 201805ë‚˜ 201812ë‚˜ ë˜‘ê°™ìŒ
print(len(conti_uselog))
#33851
conti_uselog = conti_uselog.dropna(subset=["name"])
# íƒˆí‡´í•œ íšŒì› ì œê±°
print(len(conti_uselog))
#27422
```

ì§€ì† íšŒì› ë°ì´í„°ë„ íšŒì›ë‹¹ 1ê°œê°€ ë˜ê²Œ ì–¸ë”ìƒ˜í”Œë§! -> 201805ì™€ 201812ì˜ Aì”¨ ë°ì´í„° ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ!

```py
conti_uselog = conti_uselog.sample(frac=1).reset_index(drop=True)
conti_uselog = conti_uselog.drop_duplicates(subset="customer_id")
print(len(conti_uselog))
#2842
conti_uselog.head()
```
![alt text](/assets/img_20241002/image-5.png)

### ì§€ì† íšŒì›ê³¼ íƒˆí‡´ íšŒì› ê²°í•©

```py
predict_data = pd.concat([conti_uselog, exit_uselog], ignore_index=True)
print(len(predict_data))
#3946
predict_data.head()
```
![alt text](/assets/img_20241002/image-6.png)

# 044.ì˜ˆì¸¡í•œ ë‹¬ì˜ ì¬ì (ë“±ë¡) ê¸°ê°„ì„ ì‘ì„±í•˜ì

```py
predict_data["period"] = 0
predict_data["now_date"] = pd.to_datetime(predict_data["ì—°ì›”"], format="%Y%m")
predict_data["start_date"] = pd.to_datetime(predict_data["start_date"])
for i in range(len(predict_data)):
    delta = relativedelta(predict_data["now_date"][i], predict_data["start_date"][i])
    predict_data[i] = int(delta.years*12 + delta.months)
predict_data.head()
```
![alt text](/assets/img_20241002/image-7.png)

# 045.ê²°ì¸¡ì¹˜ë¥¼ ì œê±°í•˜ì

### ê²°ì¸¡ì¹˜ ê³„ì‚°

```py
predict_data.isna().sum()
```
![alt text](/assets/img_20241002/image-8.png)

count_1ì´ ê²°ì†ëœ ë°ì´í„°ë§Œ ì œê±°!

```py
predict_data = predict_data.dropna(subset=["count_1"])
predict_data.isna().sum()
```
![alt text](/assets/img_20241002/image-9.png)

# 046.ë¬¸ìì—´ ë³€ìˆ˜ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ê°€ê³µí•˜ì

- ë”ë¯¸ ë³€ìˆ˜: ì¹´í…Œê³ ë¦¬ ë³€ìˆ˜ë¥¼ ë‹¤ë£¨ê¸° ìœ„í•´ ë§Œë“œëŠ” ê²ƒ.

### ë°ì´í„° ì¶”ì¶œ

- ì„¤ëª… ë³€ìˆ˜: count_1, campaign_name, class_name, gender, routine_flg, period
- ëª©ì  ë³€ìˆ˜: is_deleted

```py
target_col = ["campaign_name", "class_name", "gender", "count_1", "routine_flg","period", "is_deleted"]
predict_data = predict_data[target_col]
predict_data.head()
```
![alt text](/assets/img_20241002/image-10.png)

### ë”ë¯¸ ë³€ìˆ˜í™”

```py
predict_data = pd.get_dummies(predict_data)
predict_data.head()
```
![alt text](/assets/img_20241002/image-11.png)

### ë”ë¯¸ ë³€ìˆ˜ ìˆ˜ì •

â—ëª‡ê°œê°€ ì •í•´ì§€ë©´ í•˜ë‚˜ëŠ” ë¬´ì¡°ê±´ ì •í•´ì§€ê¸°ì— ì§€ì›Œì•¼ í•˜ëŠ” ì—´ì€ ì§€ì›Œì•¼í•¨!

```py
del predict_data["campaign_name_ì¼ë°˜"]
del predict_data["class_name_ì•¼ê°„"]
del predict_data["gender_M"]
predict_data.head()
```
![alt text](/assets/img_20241002/image-12.png)

# 047.ì˜ì‚¬ê²°ì • íŠ¸ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ íƒˆí‡´ ì˜ˆì¸¡ ëª¨ë¸ì„ êµ¬ì¶•í•˜ì

### íƒˆí‡´ ì˜ˆì¸¡ ëª¨ë¸ êµ¬ì¶•

```py
from sklearn.tree import DecisionTreeClassifier
import sklearn.model_selection

exit = predict_data.loc[predict_data["is_deleted"]==1]
conti = predict_data.loc[predict_data["is_deleted"]==0].sample(len(exit))
# ìœ ì§€ ë°ì´í„°ëŠ” 2842ê°œ, íƒˆí‡´ ë°ì´í„°ëŠ” 1104ê°œ ì˜€ë˜ê²ƒì„ ìœ ì§€ ë°ì´í„°ì—ì„œ ì„ì˜ë¡œ 1104ê±´ì„ ì¶”ì¶œí•´ì„œ ë¹„ìœ¨ ë§ì¶¤.

X = pd.concat([exit, conti], ignore_index = True)
y = X["is_deleted"]
del X["is_deleted"]
X_train, X_test, y_train, y_test = sklearn.model_selection.train_test_split(X,y)

model = DecisionTreeClassifier(random_state=0)
model.fit(X_train, y_train)
y_test_pred = model.predict(X_test)
print(y_test_pred)
#1ì€ íƒˆí‡´/0ì€ ìœ ì§€
```
![alt text](/assets/img_20241002/image-13.png)

### ì •ë‹µ ë°ì´í„° ì¶”ê°€

```py
results_test = pd.DataFrame({"y_test":y_test, "y_pred":y_test_pred})
results_test.head()
```
![alt text](/assets/img_20241002/image-14.png)

# 048.ì˜ˆì¸¡ ëª¨ë¸ì„ í‰ê°€í•˜ê³  ëª¨ë¸ì„ íŠœë‹í•´ ë³´ì

### í•™ìŠµìš© ë°ì´í„°ì™€ í‰ê°€ìš© ë°ì´í„°ì˜ ì˜ˆì¸¡ ì •í™•ë„

```py
correct = len(results_test.loc[results_test["y_test"]==results_test["y_pred"]])
data_count = len(results_test)
score_test = correct/data_count
print(score_test)
# 0.8992395437262357

print(model.score(X_test, y_test))
# 0.8992395437262357
print(model.score(X_train, y_train))
# 0.973384030418251
```

â—ê³¼ì í•©! -> ë°ì´í„° ëŠ˜ì´ê¸°, ë³€ìˆ˜ ì¬ê²€í† , ëª¨ë¸ íŒŒë¼ë¯¸í„° ë³€ê²½ ë“±ì˜ ë°©ë²•ìœ¼ë¡œ ì´ìƒì ì¸ ëª¨ë¸ ë§Œë“¦.

### ì˜ì‚¬ê²°ì • íŠ¸ë¦¬ì˜ ë‹¨ìˆœí™”(depth ë‚®ì¶”ê¸°)

```py
X = pd.concat([exit, conti], ignore_index = True)
y = X["is_deleted"]
del X["is_deleted"]
X_train, X_test, y_train, y_test = sklearn.model_selection.train_test_split(X,y)

model = DecisionTreeClassifier(random_state=0, max_depth=5)
model.fit(X_train, y_train)
print(model.score(X_test, y_test))
# 0.9068441064638784
print(model.score(X_train, y_train))
# 0.9328263624841572
```

# 049.ëª¨ë¸ì— ê¸°ì—¬í•˜ëŠ” ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì

```py
importance = pd.DataFrame({"feature_name":X.columns, "coefficient": model.feature_importances_})
importance
```
![alt text](/assets/img_20241002/image-15.png)

â—graphvizì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•˜ë©´ ì˜ì‚¬ê²°ì • íŠ¸ë¦¬ì˜ ê²°ê³¼ë¥¼ ê°€ì‹œí™”í•  ìˆ˜ ìˆë‹¤.

# 050.íšŒì› íƒˆí‡´ë¥¼ ì˜ˆì¸¡í•˜ì

```py
count_1 = 3
routine_flg = 1
period = 10
campaign_name = "ì…íšŒë¹„ë¬´ë£Œ"
class_name = "ì¢…ì¼"
gender = "M"

if campaign_name == "ì…íšŒë¹„ë°˜ê°’í• ì¸":
    campaign_name_list = [1,0]
elif campaign_name == "ì…íšŒë¹„ë¬´ë£Œ":
    campaign_name_list = [0,1]
elif campaign_name == "ì¼ë°˜":
    campaign_name_list = [0,0]
if class_name == "ì¢…ì¼":
    class_name_list = [1,0]
elif class_name == "ì£¼ê°„":
    class_name_list = [0.1]
elif class_name == "ì•¼ê°„":
    class_name_list = [0,0]
if gender == "F":
    gender_list = [1]
elif gender == "M":
    gender_list = [0]
input_data = [count_1, routine_flg, period]
input_data.extend(campaign_name_list)
input_data.extend(class_name_list)
input_data.extend(gender_list)

print(model.predict([input_data]))
#[1.] -> íƒˆí‡´
print(model.predict_proba([input_data]))
#[[0.04545455 0.95454545]]
```