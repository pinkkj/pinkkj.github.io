---
excerpt: "ê³¼ì œ3(EFK stack êµ¬ì¶•ì„ í†µí•œ ë¡œê·¸ ìˆ˜ì§‘)"
name: J
writer: J
categories: [Cloud Study, AWS Study] # [ë©”ì¸ ì¹´í…Œê³ ë¦¬, ì„œë¸Œ ì¹´í…Œê³ ë¦¬]
tags:
  - []

toc: true
toc_sticky: true

date: 2025-10-22
last_modified_at: 2025-10-22

# --- ì•„ë˜ ë¶€í„° content
---
# ì‹¤ìŠµê³¼ì œ
- ì£¼ì œ: EFK stack êµ¬ì¶•ì„ í†µí•œ ë¡œê·¸ ìˆ˜ì§‘
1. ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œì˜ ë¡œê·¸ ìˆ˜ì§‘ì„ ìœ„í•´ EFK(ElasticSearch + Fluentbit + Kibana) Stackì„ êµ¬ì¶•í•©ë‹ˆë‹¤.
2. ë¡œê·¸ ì €ì¥ì†Œì¸ ElasticSearch, ë¡œê·¸ ìˆ˜ì§‘ê¸°ì¸ Fluentbit, ë¡œê·¸ ì‹œê°í™” íˆ´ì¸ Kibanaë¥¼ KES í™˜ê²½ì—ì„œ êµ¬ì¶•í•©ë‹ˆë‹¤.<br>
    1) ElasticSearch êµ¬ì¶•
    2) Fluentbit êµ¬ì¶•
    3) Kibana êµ¬ì¶• 
# EFK Stack
### EFK STack êµ¬ì¶•ì„ í†µí•œ ë¡œê·¸ ìˆ˜ì§‘
1. ì»¨í…Œì´ë„ˆ í™˜ê²½ì—ì„œì˜ ë¡œê·¸ ìˆ˜ì§‘ì„ ìœ„í•´ EFK Stackì„ êµ¬ì¶•í•©ë‹ˆë‹¤.
2. ë¡œê·¸ ì €ì¥ì†Œì¸ ElasticSearch, ë¡œê·¸ ìˆ˜ì§‘ê¸°ì¸ Fluentbit, ë¡œê·¸ ì‹œê°í™” íˆ´ì¸ Kibanaë¥¼ EKS í™˜ê²½ì—ì„œ êµ¬ì¶•í•©ë‹ˆë‹¤.

### EFK?
1. ElasticSearch + Fluentbit + Kibana
2. ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” íŒŒë“œê°€ ì •ìƒìƒíƒœê°€ ì•„ë‹ˆë©´ ìƒˆë¡œ ìƒì„± -> ì£½ì€ íŒŒë“œì— ìˆëŠ” ì»¨í…Œì´ë„ˆê°€ ë‚¨ê¸´ ë¡œê·¸ëŠ” ì–´ë””ë¡œ?
3. ì»¨í…Œì´ë„ˆì˜ ë¡œê·¸ë¥¼ ë¡œê·¸ ì €ì¥ì†Œì— ìˆ˜ì§‘
  -> ì£½ì€ ì»¨í…Œì´ë„ˆì˜ ë¡œê·¸ë„ ë‚¨ëŠ”ë‹¤.

![alt text]({{ '/assets/img_20251022/image-14.png' | relative_url }})

### Fluentbit
- ì»¨í…Œì´ë„ˆì˜ ìŠ¤íŠ¸ë¦¼ ë¡œê·¸ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ë¡œê·¸ ìˆ˜ì§‘ê¸°
- ëª¨ë“  ë…¸ë“œë§ˆë‹¤ ë™ì¼í•˜ê²Œ ë°°í¬! -> Daemonset
> ğŸ˜‚Daemonset?<br> - ì¿ ë²„ë„¤í‹°ìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬(ì¿ ë²„ë„¤í‹°ìŠ¤ ê¸°ë³¸ Objectë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ëŠ” ì—­í• )(Deployment, ReplicaSet ë“±) ì¤‘ í•˜ë‚˜. <br> - Daemonsetì€ Podê°€ ê°ê°ì˜ ë…¸ë“œì— í•˜ë‚˜ì”©ë§Œ ë°°í¬ë˜ê²Œ í•˜ëŠ” Pod ê´€ë¦¬ ì»¨íŠ¸ë¡¤ëŸ¬
### ElasticSearch
- ë¡œê·¸ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ëŒ€ìš©ëŸ‰ ì €ì¥ì†Œ
- í…ìŠ¤íŠ¸, ìˆ«ì, ìœ„ì¹˜ ê¸°ë°˜ ì •ë³´, ì •í˜• ë° ë¹„ì •í˜• ë°ì´í„° ë“± ëª¨ë“  ìœ í˜•ì˜ ë°ì´í„°ë¥¼ ìœ„í•œ ë¶„ì‚°í˜• ì˜¤í”ˆ ì†ŒìŠ¤ ê²€ìƒ‰ ë° ë¶„ì„ ì—”ì§„ = ë§ì€ ì–‘ì˜ ë°ì´í„°ë¥¼ ë³´ê´€í•˜ê³  ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•˜ëŠ” ì—”ì§„
- ElasticSearch ì„¤ì¹˜í•˜ë ¤ë©´ ì›ë˜ëŠ” Java8 ì„¤ì¹˜í•˜ê³  elasticsearch install í•˜ê³  service ë‹¤ì‹œ ì‹œì‘! **í•˜ì§€ë§Œ** ì¿ ë²„ë„¤í‹°ìŠ¤ë¡œ í•˜ë©´ yaml íŒŒì¼ë¡œ ì‘ì„±í•˜ê³  ë„ìš°ë©´ ë¨!!!!
- ElasticSearchë¥¼ NodePort typeì˜ ì„œë¹„ìŠ¤ë¡œ ë°°í¬í•˜ì—¬ 2ì£¼ì°¨ ë•Œ ìƒì„±í•œ Nginxì˜ LoadBalancerì— ì—°ê²°í•˜ì—¬ í†µì‹  í™•ì¸
### Kibana
- ElasticSearchã…˜ ì—°ë™í•˜ì—¬ ë¡œê·¸ ì‹œê°í™”
  -> ë¡œê·¸ ì‹œê°í™”ë¥¼ í†µí•œ ë¬¸ì œ í•´ê²° ë° ì˜ˆë°© ê°€ëŠ¥
## 1ë‹¨ê³„. 2ì£¼ì°¨ ê³¼ì œì™€ ë™ì¼í•˜ê²Œ EKS êµ¬ì„±í•˜ê³  Nginx ì‹¤í–‰
- ê³¼ì • ë™ì¼! 2ì£¼ì°¨ ì°¸ê³ 
## 2ë‹¨ê³„ ElasticSearch ë°°í¬
### 1. elasticSearch.yamlë¡œ elasticSearch ë°°í¬ -> NodePortTypeìœ¼ë¡œ ë°°í¬
- ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ Elasticsearch ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•˜ê³ ,
VPC ë‚´ë¶€ì˜ ë‹¤ë¥¸ ë…¸ë“œë‚˜ Bastionì—ì„œ 9200/9300 í¬íŠ¸ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ ë§Œë“  ì„¤ì •
- êµ¬ì¡°
```
[ EKS Cluster ]
 â”œâ”€â”€ Node (EC2 #1)
 â”‚     â””â”€â”€ Pod (Elasticsearch container)
 â”‚
 â””â”€â”€ NodePort Service (30920/30930)
        â†³  Pod ë‚´ë¶€ì˜ 9200/9300 í¬íŠ¸ë¡œ ë¼ìš°íŒ…
```
- ëª…ë ¹ì–´
```
cat<<EOF > ~/elasticSearch.yaml
apiVersion: apps/v1
kind: Deployment 
metadata:
  name: elasticsearch
  labels:
    app: elasticsearch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: elastic/elasticsearch:6.4.0
        env:
        - name: discovery.type
          value: "single-node"
        ports:
        - containerPort: 9200
        - containerPort: 9300
        
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: elasticsearch
  name: elasticsearch-svc
  namespace: default
spec:
  ports:
  - name: elasticsearch-rest
    nodePort: 30920
    port: 9200
    protocol: TCP
    targetPort: 9200
  - name: elasticsearch-nodecom
    nodePort: 30930
    port: 9300
    protocol: TCP
    targetPort: 9300
  selector:
    app: elasticsearch
  type: NodePort
EOF
```
- Deployment â€” Elasticsearch ì‹¤í–‰ ì •ì˜
  - Deployment: ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ â€œì´ ì•±ì„ í•­ìƒ ëª‡ ê°œ ë„ì›Œì•¼ í•˜ëŠ”ì§€â€ ê´€ë¦¬í•´ì£¼ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬.
  - replicas: 1 â†’ Elasticsearch Podë¥¼ 1ê°œë§Œ ì‹¤í–‰ (ë‹¨ì¼ ë…¸ë“œ).
- Pod í…œí”Œë¦¿
  - image: elastic/elasticsearch:6.4.0
    â†’ Elasticsearch ê³µì‹ Docker ì´ë¯¸ì§€, ë²„ì „ 6.4.0
  - env: discovery.type=single-node
â†’ í´ëŸ¬ìŠ¤í„° ëª¨ë“œ ë¹„í™œì„±í™” â†’ â€œë‹¨ì¼ ë…¸ë“œâ€ë¡œ ë™ì‘
  - containerPort 9200: REST API í¬íŠ¸ (ê²€ìƒ‰ ìš”ì²­ìš©)
  - containerPort 9300: ë…¸ë“œ ê°„ í†µì‹  í¬íŠ¸ (í´ëŸ¬ìŠ¤í„° êµ¬ì„±ìš©)

<br>=> ì¦‰, ë‹¨ì¼ Elasticsearch ì„œë²„ 1ëŒ€ë¥¼ ì¿ ë²„ë„¤í‹°ìŠ¤ Pod ì•ˆì— ë„ì›Œì£¼ëŠ” ì„¤ì •ì´ì•¼.
- Service â€” NodePortë¡œ ë‚´ë¶€ ì ‘ê·¼ ì„¤ì •
  - Service: Podì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ê³ ì • ë„¤íŠ¸ì›Œí¬ ì—”ë“œí¬ì¸íŠ¸
  - selector: app: elasticsearch â†’ ìœ„ Deploymentì˜ Podì™€ ì—°ê²°ë¨
  - type: NodePort<br>
â†’ ê° ì›Œì»¤ ë…¸ë“œì˜ IPì— ê³ ì • í¬íŠ¸ë¥¼ ì—´ì–´ì¤Œ (VPC ë‚´ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥)

- Port ì„¤ì •
  - port (9200/9300)-> Service(ClusterIP) ê¸°ì¤€ í¬íŠ¸
  - targetPort (9200/9300)-> ì‹¤ì œ Pod ë‚´ë¶€ ì»¨í…Œì´ë„ˆ í¬íŠ¸
  - nodePort (30920/30930)->ê° ë…¸ë“œ(EC2)ì—ì„œ ì—´ë¦¬ëŠ” í¬íŠ¸ (NodePort ë²”ìœ„ 30000~32767)

```
kubectl apply -f elasticSearch.yaml
kubectl get pod | grep elastic
kubectl get svc | grep elastic
```
- ì •ë¦¬
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Kubernetes Cluster     â”‚
â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       Service Layer     â”‚  â”‚
â”‚  â”‚                        â”‚  â”‚
â”‚  â”‚  [my-nginx Service]  <â”€â”€â” â”‚
â”‚  â”‚  [elasticsearch-svc]  <â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                   â”‚
â”‚           â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Node(EC2)       â”‚  â”‚
â”‚  â”‚  (ip-10-0-3-187 ...)    â”‚  â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚ â”‚ nginx Pod 1â”‚          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚  â”‚
â”‚  â”‚ â”‚ nginx Pod 2â”‚          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚  â”‚
â”‚  â”‚ â”‚ elastic Pod â”‚          â”‚  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
### 2. LoadBalancer ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
- ë¦¬ìŠ¤ë„ˆë€? ë¦¬ìŠ¤ë„ˆëŠ” ì •ì˜í•œ í”„ë¡œí† ì½œê³¼ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—°ê²° ìš”ì²­ì„ í™•ì¸í•˜ëŠ” í”„ë¡œì„¸ìŠ¤. ë¦¬ìŠ¤ë„ˆì— ì •ì˜í•œ ê·œì¹™ì— ë”°ë¼ ë¡œë“œë°¸ëŸ°ì„œê°€ ë“±ë¡ëœ ëŒ€ìƒìœ¼ë¡œ ìš”ì²­ì„ ë¼ìš°íŒ… í•˜ëŠ” ë°©ë²• ê²°ì •
<br>
- ì„¤ì •
  - [Ec2] -> [ë¡œë“œë°¸ëŸ°ì„œ] -> [Listeners]íƒ­ í´ë¦­ -> [Edit] 

![alt text]({{ '/assets/img_20251022/image-15.png' | relative_url }})
-> loadbalancerì˜ 9200 portë¡œ ë“¤ì–´ì˜¤ë©´, instanceì˜ 30920ìœ¼ë¡œ trafic ë„˜ê²¨ì¤€ë‹¤.
### 3. LoadBalancerì˜ 9200 í¬íŠ¸ë¡œ ì™¸ë¶€ ì ‘ê·¼ í—ˆìš© ìœ„í•´ Loadbalancer Security group inbound rule ì¶”ê°€
- ì„¤ì •
  - [Ec2] -> [ë¡œë“œë°¸ëŸ°ì„œ] -> [Security]íƒ­ í´ë¦­ -> Security Group ID í´ë¦­ -> Security group í™”ë©´ì—ì„œ inbound rule í¸ì§‘

![alt text]({{ '/assets/img_20251022/image-16.png' | relative_url }})


```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚              AWS Load Balancer (ELB)        â”‚
                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                â”‚ Listener 1: TCP 80   â†’ Instance Port 30430  â”‚  â† nginx ì„œë¹„ìŠ¤
                â”‚ Listener 2: TCP 9200 â†’ Instance Port 30920  â”‚  â† elasticsearch ì„œë¹„ìŠ¤
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       EC2 Instance (ip-10-0-3-187 ...)     â”‚
        â”‚     (= Kubernetes Node, ì›Œì»¤ë…¸ë“œ)          â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚  kube-proxy                               â”‚
        â”‚   â”œâ”€ NodePort 30430 â†’ Pod:80 (nginx)      â”‚
        â”‚   â””â”€ NodePort 30920 â†’ Pod:9200 (elasticsearch) â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚  [Pods]                                   â”‚
        â”‚   â”œâ”€ my-nginx-xxxx  :80 (ì»¨í…Œì´ë„ˆ í¬íŠ¸)    â”‚
        â”‚   â””â”€ elasticsearch-xxxx :9200 (REST API)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3ë‹¨ê³„ Kibana
- í‚¤ë°”ë‚˜ë€?
  - Elastic Stackì„ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¶•ëœ ì˜¤í”ˆ ì†ŒìŠ¤ í”„ë¡ íŠ¸ì—”ë“œ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ, ElasticSearchì—ì„œ ìƒ‰ì¸ëœ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ê³  ì‹œê°í™”í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µ = ì˜¤í”ˆ ì†ŒìŠ¤ ê¸°ë°˜ì˜ ë¶„ì„ ë° ì‹œê°í™” í”Œë«í¼

- Kibanaë°°í¬
1. Kibana.yamlìœ¼ë¡œ kibana ë°°í¬ -> NodePortTypeìœ¼ë¡œ ë°°í¬
2. Kibanaë¥¼ Nodeport typeì˜ ì„œë¹„ìŠ¤ë¡œ ë°°í¬í•˜ì—¬ 2ì£¼ì°¨ ë•Œ ìƒì„±í•œ Nginxì˜ LoadBalancerì— ì—°ê²°í•˜ì—¬ ì™¸ë¶€ ì ‘ê·¼
### 1. Kiban.yamlë¡œ kibana ë°°í¬ > Nodeporttypeìœ¼ë¡œ ë°°í¬
```
cat<<EOF > ~/kibana.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kibana
  labels:
    app: kibana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kibana
  template:
    metadata:
      labels:
        app: kibana
    spec:
      containers:
      - name: kibana
        image: elastic/kibana:6.4.0
        env:
        - name: SERVER_NAME
          value: "kibana.kubernetes.example.com"
        - name: ELASTICSEARCH_URL
          value: "http://elasticsearch-svc.default.svc.cluster.local:9200"
        ports:
        - containerPort: 5601

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: kibana
  name: kibana-svc
  namespace: default
spec:
  ports:
  - nodePort: 30561
    port: 5601
    protocol: TCP
    targetPort: 5601
  selector:
    app: kibana
  type: NodePort
EOF
```
- Deployment/kibana
  - replicas: 1 â†’ Kibana íŒŒë“œ 1ê°œ.
  - ë¼ë²¨: app: kibana (Serviceê°€ ì´ ë¼ë²¨ë¡œ íŒŒë“œë¥¼ ì°¾ì•„ìš”)
  - ì»¨í…Œì´ë„ˆ: elastic/kibana:6.4.0
  - í¬íŠ¸: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ 5601
  - í™˜ê²½ë³€ìˆ˜:
  - SERVER_NAME="kibana.kubernetes.example.com"(SERVER_HOSTë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ 0.0.0.0ë¡œ ëœ¨ë¯€ë¡œ ë³´í†µ ì¶”ê°€ ë¶ˆí•„ìš”)
  - ELASTICSEARCH_URL="http://elasticsearch-svc.default.svc.cluster.local:9200"<br>
  â†³ í´ëŸ¬ìŠ¤í„° DNSë¡œ ESì— ë¶™ì–´ìš”. elasticsearch-svc(default ë„¤ì„ìŠ¤í˜ì´ìŠ¤)ì˜ 9200ìœ¼ë¡œ ì ‘ì†.
- Service/kibana-svc (NodePort)
  - type: NodePort
  - ì„œë¹„ìŠ¤ í¬íŠ¸ 5601 â†” NodePort 30561ë¡œ ê°œë°©
  - ì…€ë ‰í„°: app: kibana â†’ ìœ„ Deployment íŒŒë“œë¡œ ë¼ìš°íŒ…
  <br><br>
- ëª…ë ¹
```
kubectl apply -f kibana.yaml
kubectl get service
```
### 2. LoadBalncer ë¦¬ìŠ¤ë„ˆì— ì¶”ê°€
ì•ì˜ ê³¼ì •ê³¼ ë¹„ìŠ·
### 3. Loadbalncerì˜ 5601 í¬íŠ¸ë¡œ ì™¸ë¶€ ì ‘ê·¼ í—ˆìš© ìœ„í•´ Loadbalancer Security group inbound rule ì¶”ê°€
ì•ì˜ ê³¼ì •ê³¼ ë¹„ìŠ·

- ì „ì²´ êµ¬ì¡°

```
ì‚¬ìš©ì ë¸Œë¼ìš°ì €
   â”‚  http://<ì•„ë¬´ ë…¸ë“œ í¼ë¸”ë¦­IP>:30561
   â–¼
Kubernetes Node (EC2)
   â”‚  NodePort 30561
   â–¼
kibana-svc (ClusterIP)
   â”‚  targetPort 5601
   â–¼
Kibana Pod :5601
   â”‚  (ë‚´ë¶€ì—ì„œ)
   â–¼
Elasticsearch Service (ClusterIP)
   â”‚  elasticsearch-svc.default.svc.cluster.local:9200
   â–¼
Elasticsearch Pod :9200
```

## 4ë‹¨ê³„ Fluentd
- Fluentdë€?
1. ë¡œê·¸ ìˆ˜ì§‘ê¸°
2. ë‹¤ì–‘í•œ ë°ì´í„°ì†ŒìŠ¤(HTTP, TCP ë“±) ë¡œë¶€í„° ì›í•˜ëŠ” í˜•íƒœë¡œ ê°€ê³µë˜ì–´ ì—¬ëŸ¬ ëª©ì ì§€(ElasticSearch, s3) ë“±ìœ¼ë¡œ ì „ë‹¬ ê°€ëŠ¥

ğŸ”¥ì£¼ì˜: Fluentd -> FluentBit ëŒ€ì²´<br>
EKS 1.24 ì´ìƒì˜ ë²„ì „ì—ì„œë¶€í„°ëŠ” Fluentdê°€ ì•„ë‹Œ FluentBitìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤. EKS 1.24ë¶€í„°ëŠ” 1.23ê³¼ëŠ” ë‹¤ë¥´ê²Œ ëŸ°íƒ€ì„ Containerdë§Œ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ Fleuntdë¥¼ ì‚¬ìš©í•  ê²½ìš° ì •ìƒì ìœ¼ë¡œ ë¡œê·¸ ìˆ˜ì§‘ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.

### 1. fluentbit.yamlë¡œ fluentd Daemonset Pod ë°°í¬
- ì£¼ì˜: ê¼­ vi í¸ì§‘ê¸°ë¡œ ì§ì ‘ ìƒì„±!!! (cat<<EOF>> ~/fluentbit.yaml ìœ¼ë¡œ ìƒì„±X)
  - ië¡œ vi í¸ì§‘ê¸° í¸ì§‘ ëª¨ë“œë¡œ ë³€ê²½ í›„ fluentbit.yaml íŒŒì¼ì˜ ë‚´ìš© ë³µì‚¬ ë¶™ì—¬ë„£ê¸°. vi í¸ì§‘ê¸°ì— ë¶™ì—¬ë„£ê¸° í•  ë•ŒëŠ” ë§ˆìš°ìŠ¤ ìš°í´ë¦­ì„ ì´ìš©. ë¶™ì—¬ë„£ê¸° ì™„ë£Œ í›„ escë¡œ vi ì»¤ë§¨ë“œ ëª¨ë“œë¡œ ë³€ê²½ í›„ :wq ì—”í„°ë¡œ íŒŒì¼ ì €ì¥
```
cd ~/
vi fluentbit.yaml

kubectl apply -f fluentbit.yaml
kubectl get pod -n kube-system | grep fluent
```
- ì™œ ë¶™ì—¬ì•¼ í•´?
  - ì¿ ë²„ë„¤í‹°ìŠ¤ëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ êµ¬ë¶„í•´ ê´€ë¦¬í•´.
  - ë„¤ê°€ ì•„ë¬´ ì˜µì…˜ ì—†ì´ kubectl get podë¥¼ ì¹˜ë©´ default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë§Œ ì¡°íšŒí•¨.
  - ê·¸ëŸ°ë° fluent-bit(ë° coredns, kube-proxy, aws-node ë“± í´ëŸ¬ìŠ¤í„° ì»´í¬ë„ŒíŠ¸)ëŠ” ë³´í†µ kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë°°í¬ë˜ì–´ ìˆì–´.
  - ê·¸ë˜ì„œ -n kube-systemì„ ë¶™ì—¬ì•¼ ê·¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ íŒŒë“œë¥¼ ë³´ëŠ” ê±°ì•¼.
```
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluent-bit
  namespace: kube-system
  labels:
    app: fluent-bit

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fluent-bit
  labels:
    app: fluent-bit
rules:
- apiGroups: [""]
  resources:
  - pods
  - namespaces
  verbs: ["get", "list", "watch"]

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: fluent-bit
roleRef:
  kind: ClusterRole
  name: fluent-bit
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: ServiceAccount
  name: fluent-bit
  namespace: kube-system

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: kube-system
  labels:
    k8s-app: fluent-bit
data:
  # Configuration files: server, input, filters and output
  # ======================================================
  fluent-bit.conf: |
    [SERVICE]
        Flush         1
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020

    @INCLUDE input-kubernetes.conf
    @INCLUDE filter-kubernetes.conf
    @INCLUDE output-elasticsearch.conf

  input-kubernetes.conf: |
    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*.log
        Parser            docker
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On
        Refresh_Interval  10

  filter-kubernetes.conf: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off

  output-elasticsearch.conf: |
    [OUTPUT]
        Name            es
        Match           *
        Host            ${FLUENT_ELASTICSEARCH_HOST}
        Port            ${FLUENT_ELASTICSEARCH_PORT}
        Logstash_Format On
        Replace_Dots    On
        Retry_Limit     False

  parsers.conf: |
    [PARSER]
        Name   apache
        Format regex
        Regex  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
        Time_Key time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    [PARSER]
        Name   apache2
        Format regex
        Regex  ^(?<host>[^ ]*) [^ ]* (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^ ]*) +\S*)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
        Time_Key time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    [PARSER]
        Name   apache_error
        Format regex
        Regex  ^\[[^ ]* (?<time>[^\]]*)\] \[(?<level>[^\]]*)\](?: \[pid (?<pid>[^\]]*)\])?( \[client (?<client>[^\]]*)\])? (?<message>.*)$

    [PARSER]
        Name   nginx
        Format regex
        Regex ^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)")?$
        Time_Key time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    [PARSER]
        Name   json
        Format json
        Time_Key time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    [PARSER]
        Name        docker
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On

    [PARSER]
        # http://rubular.com/r/tjUt3Awgg4
        Name cri
        Format regex
        Regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<message>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name        syslog
        Format      regex
        Regex       ^\<(?<pri>[0-9]+)\>(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
        Time_Key    time
        Time_Format %b %d %H:%M:%S

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: kube-system
  labels:
    k8s-app: fluent-bit-logging
    version: v1
    kubernetes.io/cluster-service: "true"
spec:
  selector:
    matchLabels:
      k8s-app: fluent-bit-logging
      version: v1
  template:
    metadata:
      labels:
        k8s-app: fluent-bit-logging
        version: v1
        kubernetes.io/cluster-service: "true"
    spec:
      containers:
      - name: fluent-bit
        image: fluent/fluent-bit:1.3.11
        imagePullPolicy: Always
        env:
          - name:  FLUENT_ELASTICSEARCH_HOST
            value: "elasticsearch-svc.default.svc.cluster.local"
          - name:  FLUENT_ELASTICSEARCH_PORT
            value: "9200"
          - name: FLUENT_ELASTICSEARCH_SCHEME
            value: "http"
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluent-bit-config
          mountPath: /fluent-bit/etc/
      terminationGracePeriodSeconds: 10
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluent-bit-config
        configMap:
          name: fluent-bit-config
      serviceAccountName: fluent-bit
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - operator: "Exists"
        effect: "NoExecute"
      - operator: "Exists"
        effect: "NoSchedule"
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kubernetes Cluster         â”‚
â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Node A (EC2)           â”‚  â”‚
â”‚  â”‚  â”œâ”€ Pod 1 (nginx)      â”‚  â”‚
â”‚  â”‚  â”œâ”€ Pod 2 (app)        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Pod 3 (api)        â”‚  â”‚
â”‚  â”‚  â””â”€ Fluent Bit Agent ğŸŸ¢â”‚  â”‚  â† Node ë‹¨ìœ„ë¡œ 1ê°œ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Node B (EC2)           â”‚  â”‚
â”‚  â”‚  â”œâ”€ Pod 4 (db)         â”‚  â”‚
â”‚  â”‚  â””â”€ Fluent Bit Agent ğŸŸ¢â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
### 2. Kibana ì¸ë±ìŠ¤ íŒ¨í„´ ìƒì„±
- [Management] -> [Index patterns] -> index pattern:logstash-* -> next step -> @timestamp -> create index pattern

![alt text]({{ '/assets/img_20251022/image-17.png' | relative_url }})
![alt text]({{ '/assets/img_20251022/image-18.png' | relative_url }})
-> í™•ì¸í•˜ê¸°! ìƒì„±ëœ Fieldsì— Kubernetes.labels.runì´ ê²€ìƒ‰ë˜ì§€ ì•ŠëŠ” ê²½ìš° ë¡œê·¸ ìˆ˜ì§‘ì´ ëœ ë˜ì—ˆê¸° ë•Œë¬¸!!

### 3. ë¡œê·¸ ì‹œê°í™”
- [Discover] -> ê²€ìƒ‰í•„í„° ì„¤ì • -> kubernetes.labels.run is my-nginx(nginx ë°°í¬ ë•Œ ì‚¬ìš©í•œ Label)

![alt text]({{ '/assets/img_20251022/image-19.png' | relative_url }})

## 5ë‹¨ê³„ ìì› ì‚­ì œ
1. kubernetes ìì› ì‚­ì œ
```
kubectl delete -f elasticSearch.yaml
kubectl delete -f kibana.yaml
kubectl delete -f fluentbit.yaml
kubectl delete -f nginx-service.yaml
kubectl delete -f nginx-deployment.yaml
```
2. EKS clusterì™€ Node Group ì‚­ì œ
```
eksctl delete cluster --region ap-northeast-2 --name=mission-cluster
```